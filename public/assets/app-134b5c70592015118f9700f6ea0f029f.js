var app=angular.module("allesongs",["ngResource","ngRoute","ngSanitize","ngCookies","ngDraggable","ui.bootstrap","willPaginate","xeditable"]);app.factory("Playlist",["$resource",function(t){return t("/api/playlists/:id",{id:"@id"},{update:{method:"PUT"}})}]),app.run(function(t){t.theme="bs3"}),app.controller("MainCtrl",["$scope","$resource","$http","$cookieStore","Playlist",function(t,a,e,n,o){var s=a("/api/playitems/:id");t.go=function(t){path="/#",angular.forEach(t,function(t){path+="/"+t.replace("&","e").replace("/"," ").replace("."," ")}),path=encodeURI(path),console.log(path),location.href=path},t.play=function(a){void 0!=a?t.current_playitem=a:void 0!=t.playitems[0]&&(t.current_playitem=t.playitems[0])},t.loadPlaylist=function(a){t.current_playlist=a,s.query({playlist_id:a.id},function(a){t.playitems=a,n.put("current_playlist",t.current_playlist),t.playitems.length>0&&t.play(t.playitems[0])})},t.updatePlaylist=function(a){o.update({name:a},t.current_playlist),t.loadPlaylists()},t.loadPlaylists=function(){t.playlists=o.query()},t.addToPlaylist=function(a,e){var n=new s({name:a.name,artist:a.artist.name||a.artist,picture:a.image?a.image[3]["#text"]:a.picture,duration:a.duration,playlist_id:t.current_playlist.id});s.save(n,function(a){t.playitems.push(a),setTimeout(function(){$("#playlist").slimScroll({scrollTo:"10000px"})},100),(e||void 0==t.current_playitem)&&t.play(a)})},t.addAlbumToPlaylist=function(a,e){lastfm.album.getInfo({album:a.name,artist:a.artist.name||a.artist},{success:function(n){angular.forEach(n.album.tracks.track,function(n,o){n.image=a.image,n.picture=a.picture,t.addToPlaylist(n,0==o&&e)}),t.$digest()}})},t.addArtistToPlaylist=function(a,e){lastfm.artist.getTopTracks({artist:a.name},{success:function(a){angular.forEach(a.toptracks.track,function(a,n){t.addToPlaylist(a,1==n&&e)}),t.$digest()}})},t.clearPlaylist=function(){angular.forEach(t.playitems,function(a){t.removeFromPlaylist(a)})},t.removePlaylist=function(a){o.delete({id:a.id},function(){t.playlists.splice(t.playlists.indexOf(a),1)})},t.removeFromPlaylist=function(a){s.delete({id:a.id},function(){t.playitems.splice(t.playitems.indexOf(a),1)})},t.setError=function(t){console.log("error..."),console.log(t)},t.loadNext=function(){if(t.playitems.length>1){var a=t.playitems.indexOf(t.current_playitem)+1;void 0!=t.playitems[a]?t.play(t.playitems[a]):t.play(t.playitems[0])}},t.loadPrevious=function(){if(t.playitems.length>1){var a=t.playitems.indexOf(t.current_playitem)-1;console.log(a),a>=0?t.play(t.playitems[a]):t.play(t.playitems[t.playitems.length-1])}},t.displayVideoMeta=function(t,a){"undefined"!=a&&(artist=t.artist,subtitle=t.name,title=artist+" - "+subtitle,$("title").text(title),lyric="",translation_text="",a.info&&a.info.mus&&"exact"==a.info.type?(lyric=a.info.mus[0].text,lyric+='<br/><br/><p><a style="font-size:10px;color:#000;text-decoration:none;font-weight:bold" target=_blank href="'+a.info.mus[0].url+'"><img src="http://www.vagalume.com.br/images/logo_small2.jpg" alt="Vagalume"><br/>Letras de Músicas</a></p>',a.info.mus[0].translate&&(translation_text=a.info.mus[0].translate[0].text.replace("[","<b>").replace("]","</b>"))):lyric="Letra não encontrada")},t.renderPlayer=function(a){return new YT.Player("player_container",{width:"100%",height:"280px",videoId:a,playerVars:{autoplay:1,iv_load_policy:3,rel:0,showinfo:1},events:{onReady:t.onPlayerReady,onStateChange:t.onPlayerStateChange,onError:t.onPlayerError}})},t.onPlayerReady=function(a){t.is_iPhone?player.playVideo():a.target.playVideo()},t.is_iPhone=function(){-1!=navigator.userAgent.toLowerCase().indexOf("iphone")},t.pauseVideo=function(){player.pauseVideo()},t.playVideo=function(){player.playVideo()},t.onPlayerStateChange=function(a){t.playing=1==a.data,a.data==YT.PlayerState.ENDED&&t.loadNext(),t.$digest()},t.onPlayerError=function(a){(150==a.data||101==a.data)&&t.loadNext()},t.loadTags=function(){lastfm.tag.getTopTags({success:function(a){t.toptags=a.toptags.tag,t.$digest()}})},t.onDropComplete=function(a){console.log("drop success, data:",a),void 0==a.artist?t.addArtistToPlaylist(a):void 0==a.duration?t.addAlbumToPlaylist(a):t.addToPlaylist(a)},t.showSignInModal=function(){$("#signin_modal").modal("show")},t.hideSignInModal=function(){$("#signin_modal").modal("hide")},t.$watch("current_playitem",function(a){void 0!=a&&$.getJSON(a.url,function(e){t.displayVideoMeta(a,e),e.video?("undefined"==typeof player?player=t.renderPlayer(e.video):player.loadVideoById(e.video),t.is_iPhone&&window.scrollTo(0,0)):t.setError(a)})}),t.$watch("playing",function(t){console.log("Now playing: "+t)}),t.$watch("current_user",function(a){console.log("Current user changed to: "+a),void 0!=a&&(t.loadPlaylists(),t.hideSignInModal())}),t.loadPlaylists(),void 0!=n.get("current_playlist")?t.loadPlaylist(n.get("current_playlist")):e.get("/api/playlists/default.json").success(function(a){t.loadPlaylist(a)}).error(function(t){console.log("error: "+t)}),t.loadTags(),e.get("/users.json").success(function(a){t.$parent.fetch_status=a.status,t.$parent.current_user=a,t.hideSignInModal()}).error(function(a){t.showSignInModal(),console.log("error: "+a),t.$parent.fetch_status=a.status}),$("#suggest_input").bind("typeahead:selected",function(a,e,n){"artists"==n?t.go([e.name]):"albums"==n?t.go([e.artist,e.name]):"tracks"==n?t.addToPlaylist(e,!0):"tags"==n&&t.go(["tag",e.name])}),$("#suggest_input").typeahead(null,{name:"artists",displayKey:"name",source:function(t,a){$.get("http://ws.audioscrobbler.com/2.0/?method=artist.search&limit=5&artist="+t+"&api_key=99a3723ef564b7395271af5fd39dad6a&format=json",function(t){a(t.results.artistmatches.artist)})},templates:{header:'<h4 class="tt-header">Artistas</h4>',suggestion:function(t){return'<p><a><img src="'+(t.image?t.image[0]["#text"]:"")+'" /><strong>'+t.name+"</strong></a><p>"}}},{name:"albums",displayKey:"name",source:function(t,a){$.get("http://ws.audioscrobbler.com/2.0/?method=album.search&limit=5&album="+t+"&api_key=99a3723ef564b7395271af5fd39dad6a&format=json",function(t){a(t.results.albummatches.album)})},templates:{header:'<h4 class="tt-header">Albums</h4>',suggestion:function(t){return'<p><a><img src="'+(t.image?t.image[0]["#text"]:"")+'" /><strong>'+t.name+"</strong> - <span>"+t.artist+"</span></a><p>"}}},{name:"tracks",displayKey:"name",source:function(t,a){$.get("http://ws.audioscrobbler.com/2.0/?method=track.search&limit=5&track="+t+"&api_key=99a3723ef564b7395271af5fd39dad6a&format=json",function(t){a(t.results.trackmatches.track)})},templates:{header:'<h4 class="tt-header">Músicas</h4>',suggestion:function(t){return'<p><a><img src="'+(t.image?t.image[0]["#text"]:"")+'" /><strong>'+t.name+"</strong> - <span>"+t.artist+"</span></a> <p>"}}},{name:"tags",displayKey:"name",source:function(t,a){$.get("http://ws.audioscrobbler.com/2.0/?method=tag.search&limit=5&tag="+t+"&api_key=99a3723ef564b7395271af5fd39dad6a&format=json",function(t){a(t.results.tagmatches.tag)})},templates:{header:'<h4 class="tt-header">Tags</h4>',suggestion:function(t){return"<p><a><strong>"+t.name+"</strong></a> <p>"}}})}]),app.controller("ArtistCtrl",["$scope","$routeParams",function(t,a){lastfm.artist.getInfo({artist:a.artist_name},{success:function(a){t.artist=a.artist,t.$digest(),lastfm.artist.getTopAlbums({artist:t.artist.name},{success:function(a){t.artist.top_albums=a.topalbums.album,t.$digest()}})}}),t.load_top_tracks=function(){t.artist.top_tracks||lastfm.artist.getTopTracks({artist:t.artist.name},{success:function(a){t.artist.top_tracks=a.toptracks.track,t.$digest()}})},t.load_events=function(){t.artist.events||lastfm.artist.getEvents({artist:t.artist.name},{success:function(a){t.artist.events=a.events.event,t.$digest()}})},t.playitems[0]&&t.play(t.playitems[0])}]),app.controller("AlbumCtrl",["$scope","$resource",function(){}]),app.controller("TopCtrl",["$scope","$resource",function(t,a){var e=a("/api/artists/:id"),n=a("/api/albums/:id"),o=a("/api/tracks/:id");t.top_artists=e.query(),t.top_albums=n.query(),t.top_tracks=o.query()}]),app.controller("TagCtrl",["$scope","$routeParams",function(t,a){t.tag={name:a.tag_name},lastfm.tag.getTopArtists({tag:a.tag_name,limit:12},{success:function(a){t.tag.top_artists=a.topartists.artist,t.$digest()}}),lastfm.tag.getTopAlbums({tag:a.tag_name,limit:12},{success:function(a){t.tag.top_albums=a.topalbums.album,t.$digest()}}),lastfm.tag.getTopTracks({tag:a.tag_name,limit:12},{success:function(a){t.tag.top_tracks=a.toptracks.track,t.$digest()}})}]),app.config(function(t){t.when("/top",{templateUrl:function(){return"/top?angular=true"},controller:"TopCtrl"}),t.when("/:tag/:tag_name",{templateUrl:function(t){return"/tag/"+t.tag_name+"?angular=true"},controller:"TagCtrl"}),t.when("/:artist_name",{templateUrl:function(t){return"/"+t.artist_name+"?angular=true"},controller:"ArtistCtrl"}),t.when("/:artist_name/:album_name",{templateUrl:function(t){return"/"+t.artist_name+"/"+t.album_name+"?angular=true"},controller:"AlbumCtrl"}),t.otherwise({redirectTo:"/top"})}),app.directive("showtab",function(){return{link:function(t,a){a.click(function(t){t.preventDefault(),$(a).tab("show")})}}}),app.filter("html_filter",function(t){return function(a){return t.trustAsHtml(a.split("http://www.last.fm/music/").join("/#/").split("http://www.last.fm/tag/").join("/#/tag/").split("+").join(" ").split("Last.fm").join("AlleSongs.com"))}}),app.filter("int_to_date",function(){return function(t){for(var a=Math.floor(t/3600),e=Math.floor((t-3600*a)/60),n=t-3600*a-60*e;e.length<2;)e="0"+e;for(;n.length<2;)n="0"+e;return new Date(0,0,0,a,e,n,0)}}),app.directive("facebook",function(t){return{restrict:"A",scope:!0,controller:function(a){function e(){FB.login(function(t){t.authResponse?(console.log("FB.login connected"),n()):console.log("FB.login cancelled")},{scope:"email,read_stream"})}function n(){FB.getLoginStatus(function(e){"connected"===e.status?(a.auth=e.authResponse,t.get("/users/auth/facebook/callback?access_token="+a.auth.accessToken,{}).success(function(t){a.$parent.fetch_status=t.status,a.$parent.current_user=t}).error(function(t){console.log("error: "+t),a.$parent.fetch_status=t.status})):"not_authorized"===e.status?console.log("not_authorized"):console.log("not_logged_in")})}!function(t){var a,e="facebook-jssdk",n=t.getElementsByTagName("script")[0];t.getElementById(e)||(a=t.createElement("script"),a.id=e,a.async=!0,a.src="//connect.facebook.net/en_US/all.js",n.parentNode.insertBefore(a,n))}(document),a.fetch=function(){"connected"==a.login_status?n():e()}},link:function(t,a,e){window.fbAsyncInit=function(){FB.init({appId:e.facebook,channelUrl:"//localhost:3000/channel.html",status:!0,cookie:!0,xfbml:!0})}}}});