var app=angular.module("allesongs",["ngResource","ngRoute","ngSanitize","ngCookies","ngDraggable","ui.bootstrap","willPaginate","xeditable","Devise"]);app.factory("Playlist",["$resource",function(t){return t("/api/playlists/:id",{id:"@id"},{update:{method:"PUT"}})}]),app.run(function(t,a){a.theme="bs3",t.alert=new Alert}),app.controller("MainCtrl",["$scope","$resource","$http","$cookieStore","Playlist","Auth",function(t,a,e,n,o,i){var s=a("/api/playitems/:id"),r=a("/api/tracks/:id");t.go=function(t){path="/#",angular.forEach(t,function(t){path+="/"+t.replace("&","e").replace("/"," ").replace("."," ")}),path=encodeURI(path),console.log(path),location.href=path},t.play=function(a){void 0!=a?t.current_playitem=a:void 0!=t.playitems[0]&&(t.current_playitem=t.playitems[0])},t.loadCurrentPlaylist=function(a){t.current_playlist=a,s.query({playlist_id:a.id},function(a){t.setPlayitems(a)})},t.loadPlaylist=function(a){e.get("/api/playlists/"+a.id+"/load.json?current_playlist="+t.current_playlist.id).success(function(a){t.setPlayitems(a)}).error(function(t){console.log("error: "+t)})},t.setPlayitems=function(a){t.playitems=a,n.put("current_playlist",t.current_playlist),t.playitems.length>0&&t.play(t.playitems[0])},t.savePlaylist=function(a){var e=new s({name:a});o.save({current_playlist:t.current_playlist.id},e,function(a){t.playlists.push(a)}),t.current_playlist.name=void 0},t.login_and=function(){i.isAuthenticated()||t.showSignInModal()},t.updatePlaylist=function(a){o.update({name:a},t.current_playlist,function(a){t.loadPlaylists(),console.log(a)})},t.loadPlaylists=function(){t.playlists=o.query()},t.addToPlaylist=function(a,e){var n=new s({name:a.name,artist:a.artist.name||a.artist,picture:a.image?a.image[3]["#text"]:a.picture,duration:a.duration,playlist_id:t.current_playlist.id});s.save(n,function(a){t.playitems.push(a),setTimeout(function(){$("#playlist").slimScroll({scrollTo:"10000px"})},100),(e||void 0==t.current_playitem)&&t.play(a)})},t.addTracksToPlaylist=function(a,e){angular.forEach(a,function(a,n){t.addToPlaylist(a,0==n&&e)})},t.addSampleTracksToPlaylist=function(a){r.query({per_page:100,order:"code asc"},function(e){t.addTracksToPlaylist(e,a)})},t.addAlbumToPlaylist=function(a,e){lastfm.album.getInfo({album:a.name,artist:a.artist.name||a.artist},{success:function(n){angular.forEach(n.album.tracks.track,function(n,o){n.image=a.image,n.picture=a.picture,t.addToPlaylist(n,0==o&&e)}),t.$digest()}})},t.addArtistToPlaylist=function(a,e){lastfm.artist.getTopTracks({artist:a.name},{success:function(a){angular.forEach(a.toptracks.track,function(a,n){t.addToPlaylist(a,1==n&&e)}),t.$digest()}})},t.addTagToPlaylist=function(a,e){lastfm.tag.getTopTracks({tag:a.name},{success:function(a){angular.forEach(a.toptracks.track,function(a,n){t.addToPlaylist(a,1==n&&e)}),t.$digest()}})},t.clearPlaylist=function(){angular.forEach(t.playitems,function(a){t.removeFromPlaylist(a)})},t.removePlaylist=function(a){o.delete({id:a.id},function(){t.playlists.splice(t.playlists.indexOf(a),1)})},t.removeFromPlaylist=function(a){s.delete({id:a.id},function(){t.playitems.splice(t.playitems.indexOf(a),1)})},t.setError=function(t){console.log("error..."),console.log(t)},t.loadNext=function(){if(t.playitems.length>1){var a=t.playitems.indexOf(t.current_playitem)+1;void 0!=t.playitems[a]?t.play(t.playitems[a]):t.play(t.playitems[0])}},t.loadPrevious=function(){if(t.playitems.length>1){var a=t.playitems.indexOf(t.current_playitem)-1;console.log(a),a>=0?t.play(t.playitems[a]):t.play(t.playitems[t.playitems.length-1])}},t.displayVideoMeta=function(t,a){"undefined"!=a&&(artist=t.artist,subtitle=t.name,title=artist+" - "+subtitle,$("title").text(title),lyric="",translation_text="")},t.renderPlayer=function(a){return new YT.Player("player_container",{width:"100%",height:"280px",videoId:a,playerVars:{autoplay:1,iv_load_policy:3,rel:0,showinfo:1},events:{onReady:t.onPlayerReady,onStateChange:t.onPlayerStateChange,onError:t.onPlayerError}})},t.onPlayerReady=function(a){t.is_iPhone?player.playVideo():a.target.playVideo()},t.is_iPhone=function(){-1!=navigator.userAgent.toLowerCase().indexOf("iphone")},t.pauseVideo=function(){player.pauseVideo()},t.playVideo=function(){player.playVideo()},t.onPlayerStateChange=function(a){t.playing=1==a.data,a.data==YT.PlayerState.ENDED&&t.loadNext(),t.$digest()},t.onPlayerError=function(a){(150==a.data||101==a.data)&&t.loadNext()},t.loadTags=function(){lastfm.tag.getTopTags({success:function(a){t.toptags=a.toptags.tag,t.$digest()}})},t.dropOnCurrentPlaylist=function(a,e){console.log("drop success, data:",e),console.log(a),void 0===e.artist?t.addArtistToPlaylist(e):void 0===e.duration?t.addAlbumToPlaylist(e):t.addToPlaylist(e)},t.showSignInModal=function(){$("#signin_modal").modal("show")},t.focusSearch=function(){$("#suggest_input").focus()},t.hideSignInModal=function(){$("#signin_modal").modal("hide"),t.focusSearch()},t.setCurrentUser=function(a){t.current_user=a,console.log("Current user changed to: "),console.log(t.current_user),void 0!=t.current_user&&(t.loadPlaylists(),t.hideSignInModal())},t.$watch("current_playitem",function(a){void 0!=a&&$.getJSON(a.url,function(e){t.displayVideoMeta(a,e),e.video?("undefined"==typeof player?player=t.renderPlayer(e.video):player.loadVideoById(e.video),t.is_iPhone&&window.scrollTo(0,0)):t.setError(a)})}),t.$watch("playing",function(t){console.log("Now playing: "+t)}),i.currentUser().then(function(a){console.log(a),t.setCurrentUser(a.data)},function(a){console.log("User not authenticated: "+a),t.showSignInModal()}),void 0!=n.get("current_playlist")?t.loadCurrentPlaylist(n.get("current_playlist")):e.get("/api/playlists/default.json").success(function(a){t.loadCurrentPlaylist(a)}).error(function(t){console.log("error: "+t)}),t.loadTags(),$("#suggest_input").bind("typeahead:selected",function(a,e,n){"artists"==n?t.go([e.name]):"albums"==n?t.go([e.artist,e.name]):"tracks"==n?t.addToPlaylist(e,!0):"tags"==n&&t.go(["tag",e.name])}),$("#suggest_input").typeahead(null,{name:"artists",displayKey:"name",source:function(t,a){$.get("http://ws.audioscrobbler.com/2.0/?method=artist.search&limit=5&artist="+t+"&api_key=99a3723ef564b7395271af5fd39dad6a&format=json",function(t){a(t.results.artistmatches.artist)})},templates:{header:'<h4 class="tt-header">Artistas</h4>',suggestion:function(t){return'<p><a><img src="'+(t.image?t.image[0]["#text"]:"")+'" /><strong>'+t.name+"</strong></a><p>"}}},{name:"albums",displayKey:"name",source:function(t,a){$.get("http://ws.audioscrobbler.com/2.0/?method=album.search&limit=5&album="+t+"&api_key=99a3723ef564b7395271af5fd39dad6a&format=json",function(t){a(t.results.albummatches.album)})},templates:{header:'<h4 class="tt-header">Albums</h4>',suggestion:function(t){return'<p><a><img src="'+(t.image?t.image[0]["#text"]:"")+'" /><strong>'+t.name+"</strong> - <span>"+t.artist+"</span></a><p>"}}},{name:"tracks",displayKey:"name",source:function(t,a){$.get("http://ws.audioscrobbler.com/2.0/?method=track.search&limit=5&track="+t+"&api_key=99a3723ef564b7395271af5fd39dad6a&format=json",function(t){a(t.results.trackmatches.track)})},templates:{header:'<h4 class="tt-header">MÃºsicas</h4>',suggestion:function(t){return'<p><a><img src="'+(t.image?t.image[0]["#text"]:"")+'" /><strong>'+t.name+"</strong> - <span>"+t.artist+"</span></a> <p>"}}},{name:"tags",displayKey:"name",source:function(t,a){$.get("http://ws.audioscrobbler.com/2.0/?method=tag.search&limit=5&tag="+t+"&api_key=99a3723ef564b7395271af5fd39dad6a&format=json",function(t){a(t.results.tagmatches.tag)})},templates:{header:'<h4 class="tt-header">Tags</h4>',suggestion:function(t){return"<p><a><strong>"+t.name+"</strong></a> <p>"}}})}]),app.controller("ArtistCtrl",["$scope","$routeParams",function(t,a){lastfm.artist.getInfo({artist:a.artist_name},{success:function(a){t.artist=a.artist,t.$digest(),console.log(t.artist),lastfm.artist.getTopAlbums({artist:t.artist.name},{success:function(a){t.artist.top_albums=a.topalbums.album,t.artist.top_albums?t.$digest():($('[href="#profile-tabs-top-albums"]').parent().hide(),$('[href="#profile-tabs-top-tracks"]').click())}})}}),t.load_top_tracks=function(){t.artist.top_tracks||lastfm.artist.getTopTracks({artist:t.artist.name},{success:function(a){t.artist.top_tracks=a.toptracks.track,t.$digest()}})},t.load_events=function(){t.artist.events||lastfm.artist.getEvents({artist:t.artist.name},{success:function(a){t.artist.events=a.events.event,t.$digest()}})},t.playitems[0]&&t.play(t.playitems[0])}]),app.controller("AlbumCtrl",["$scope","$resource",function(){}]),app.controller("SignInCtrl",["$scope","$resource","Auth",function(t,a,e){t.user={},t.signin=function(a){e.login(a).then(function(a){t.setCurrentUser(a)},function(a){angular.forEach(a.data.errors,function(a){t.alert.add(a,{container:"signin-errors",auto_close:3})}),console.log("Authentication failed: "),console.log(a)})},t.signup=function(a){e.register(a).then(function(a){t.setCurrentUser(a)},function(a){angular.forEach(a.data.errors,function(a,e){t.alert.add(e+" "+a,{container:"signup-errors",auto_close:3})}),console.log("Registration failed: "),console.log(a)})},t.$on("devise:login",function(a,n){e.isAuthenticated()&&t.setCurrentUser(n)}),t.$on("devise:new-registration",function(){})}]),app.controller("TopCtrl",["$scope","$resource",function(t,a){var e=a("/api/artists/:id"),n=a("/api/albums/:id"),o=a("/api/tracks/:id");t.top_artists=e.query(),t.top_albums=n.query(),t.top_tracks=o.query()}]),app.controller("TagCtrl",["$scope","$routeParams",function(t,a){t.tag={name:a.tag_name},lastfm.tag.getTopArtists({tag:a.tag_name,limit:12},{success:function(a){t.tag.top_artists=a.topartists.artist,t.$digest()}}),lastfm.tag.getTopAlbums({tag:a.tag_name,limit:12},{success:function(a){t.tag.top_albums=a.topalbums.album,t.$digest()}}),lastfm.tag.getTopTracks({tag:a.tag_name,limit:20},{success:function(a){t.tag.top_tracks=a.toptracks.track,t.$digest()}})}]),app.config(function(t){init.push(function(){}),window.PixelAdmin.start(init),t.when("/top",{templateUrl:function(){return"/top?angular=true"},controller:"TopCtrl"}),t.when("/tag/:tag_name",{templateUrl:function(t){return"/tag/"+t.tag_name+"?angular=true"},controller:"TagCtrl"}),t.when("/:artist_name",{templateUrl:function(t){return"/"+t.artist_name+"?angular=true"},controller:"ArtistCtrl"}),t.when("/:artist_name/:album_name",{templateUrl:function(t){return"/"+t.artist_name+"/"+t.album_name+"?angular=true"},controller:"AlbumCtrl"}),t.otherwise({redirectTo:"/top"})}),app.directive("showtab",function(){return{link:function(t,a){a.click(function(t){t.preventDefault(),$(a).tab("show")})}}}),app.filter("html_filter",function(t){return function(a){return t.trustAsHtml(a.split("http://www.last.fm/music/").join("/#/").split("http://www.last.fm/tag/").join("/#/tag/").split("+").join(" ").split("Last.fm").join("AlleSongs.com"))}}),app.filter("int_to_date",function(){return function(t){for(var a=Math.floor(t/3600),e=Math.floor((t-3600*a)/60),n=t-3600*a-60*e;e.length<2;)e="0"+e;for(;n.length<2;)n="0"+e;return new Date(0,0,0,a,e,n,0)}}),app.directive("facebook",function(t){return{restrict:"A",scope:!0,controller:function(a){function e(){FB.login(function(t){t.authResponse?(console.log("FB.login connected"),n()):console.log("FB.login cancelled")},{scope:"email,read_stream"})}function n(){console.log("1"),FB.getLoginStatus(function(e){console.log("2"),"connected"===e.status?(console.log("3"),a.auth=e.authResponse,t.get("/users/auth/facebook/callback?access_token="+a.auth.accessToken,{}).success(function(t){a.setCurrentUser(t)}).error(function(t){console.log("error: "+t)})):"not_authorized"===e.status?console.log("not_authorized"):console.log("not_logged_in")})}!function(t){var a,e="facebook-jssdk",n=t.getElementsByTagName("script")[0];t.getElementById(e)||(a=t.createElement("script"),a.id=e,a.async=!0,a.src="//connect.facebook.net/en_US/all.js",n.parentNode.insertBefore(a,n))}(document),a.fetch=function(){"connected"==a.login_status?n():e()}},link:function(t,a,e){window.fbAsyncInit=function(){FB.init({appId:e.facebook,channelUrl:"//localhost:3000/channel.html",status:!0,cookie:!0,xfbml:!0})}}}});